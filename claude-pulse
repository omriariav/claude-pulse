#!/bin/bash
# claude-pulse v1.1: Real-time token usage for Claude Code status line
# Now uses native context_window data (Claude Code v2.0.65+)
# Falls back to transcript parsing for older versions

# Read JSON input from stdin
input=$(cat)

# Extract values from JSON
cwd=$(echo "$input" | jq -r '.cwd')

# Try native context_window data first (Claude Code v2.0.65+)
input_tokens=$(echo "$input" | jq -r '.context_window.total_input_tokens // null')
output_tokens=$(echo "$input" | jq -r '.context_window.total_output_tokens // null')
context_limit=$(echo "$input" | jq -r '.context_window.context_window_size // null')

# If native data available, use it
if [[ "$input_tokens" != "null" ]] && [[ -n "$input_tokens" ]]; then
    # Native mode: total tokens = input + output
    input_tokens=$((input_tokens + output_tokens))
else
    # Fallback: Parse transcript files (for Claude Code < v2.0.65)
    transcript_path=$(echo "$input" | jq -r '.transcript_path')
    session_id=$(echo "$input" | jq -r '.session_id')
    model_id=$(echo "$input" | jq -r '.model.id // "claude-sonnet-4-5-20250929"')

    # Check if transcript file exists
    if [[ ! -f "$transcript_path" ]]; then
        printf "üß† Transcript not found\nüìÅ ${cwd}"
        exit 0
    fi

    # Parse transcript JSONL from bottom-up to find last assistant message with usage data
    input_tokens=$(tail -r "$transcript_path" 2>/dev/null | jq --arg sid "$session_id" -s '
        map(select(.sessionId == $sid and .message.usage)) |
        if length > 0 then
            .[0].message.usage |
            ((.input_tokens // 0) +
             (.cache_creation_input_tokens // 0) +
             (.cache_read_input_tokens // 0))
        else
            null
        end
    ' 2>/dev/null)

    # Determine context limit based on model ID
    case "$model_id" in
        claude-opus-4*|claude-sonnet-4*|claude-sonnet-3-7*|claude-3-7-sonnet*)
            context_limit=200000
            ;;
        claude-haiku-3-5*|claude-3-5-haiku*)
            context_limit=200000
            ;;
        claude-opus-3*|claude-sonnet-3-5*|claude-3-5-sonnet*|claude-3-opus*)
            context_limit=200000
            ;;
        *)
            context_limit=200000
            ;;
    esac
fi

# If no usage data found yet
if [[ -z "$input_tokens" ]] || [[ "$input_tokens" == "null" ]]; then
    printf "üß† No token usage yet\nüìÅ ${cwd}"
    exit 0
fi

# Calculate percentage
percent=$(awk "BEGIN {printf \"%.0f\", ($input_tokens/$context_limit)*100}")

# Format with K notation (e.g., "48k" instead of "48,000")
if (( input_tokens >= 1000 )); then
    tokens_fmt=$(awk "BEGIN {printf \"%.0fk\", $input_tokens/1000}")
else
    tokens_fmt="${input_tokens}"
fi

# Format context limit with K notation
if (( context_limit >= 1000 )); then
    limit_fmt=$(awk "BEGIN {printf \"%.0fk\", $context_limit/1000}")
else
    limit_fmt="${context_limit}"
fi

# Color based on percentage (matching ccusage thresholds)
if (( percent >= 80 )); then
    color="\033[31m"  # Red
elif (( percent >= 50 )); then
    color="\033[33m"  # Yellow
else
    color="\033[32m"  # Green
fi
reset="\033[0m"

# Output format: "üß† 64k/200k (32%)" - shows usage, limit, and percentage
printf "${color}üß† ${tokens_fmt}/${limit_fmt} (${percent}%%)${reset}\nüìÅ ${cwd}"
