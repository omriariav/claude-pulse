#!/bin/bash
# claude-pulse v1.4.1: Real-time token usage for Claude Code status line
# Uses billing API (transcript) for accurate FULL context usage
# Falls back to native context_window when transcript unavailable
# Displays current model name (e.g., "Sonnet 4.5")

# Read JSON input from stdin
input=$(cat)

# Extract values from JSON
cwd=$(echo "$input" | jq -r '.cwd')
transcript_path=$(echo "$input" | jq -r '.transcript_path')
session_id=$(echo "$input" | jq -r '.session_id')
model_id=$(echo "$input" | jq -r '.model.id // "claude-sonnet-4-5-20250929"')

# Convert model ID to friendly name
case "$model_id" in
    claude-opus-4*)
        model_name="Opus 4.5"
        context_limit=200000
        ;;
    claude-sonnet-4*)
        model_name="Sonnet 4.5"
        context_limit=200000
        ;;
    claude-haiku-3-5*|claude-3-5-haiku*)
        model_name="Haiku 3.5"
        context_limit=200000
        ;;
    claude-sonnet-3-5*|claude-3-5-sonnet*)
        model_name="Sonnet 3.5"
        context_limit=200000
        ;;
    claude-opus-3*|claude-3-opus*)
        model_name="Opus 3"
        context_limit=200000
        ;;
    claude-sonnet-3-7*|claude-3-7-sonnet*)
        model_name="Sonnet 3.7"
        context_limit=200000
        ;;
    *)
        model_name="Claude"
        context_limit=200000
        ;;
esac

# Check for actual context window size from JSON (overrides hardcoded defaults)
actual_limit=$(echo "$input" | jq -r '.context_window.context_window_size // null')
if [[ "$actual_limit" != "null" ]] && [[ -n "$actual_limit" ]]; then
    context_limit="$actual_limit"
fi

# Primary: Billing API from transcript (includes ALL context: messages + system + MCP tools)
# Sum: input_tokens + cache_creation_input_tokens + cache_read_input_tokens
# This matches what /context shows
if [[ -f "$transcript_path" ]]; then
    # Use tail -r on macOS, tac on Linux
    if command -v tac &>/dev/null; then
        reverse_cmd="tac"
    else
        reverse_cmd="tail -r"
    fi
    input_tokens=$($reverse_cmd "$transcript_path" 2>/dev/null | jq --arg sid "$session_id" -s '
        map(select(.sessionId == $sid and .message.usage)) |
        if length > 0 then
            .[0].message.usage |
            ((.input_tokens // 0) + (.cache_creation_input_tokens // 0) + (.cache_read_input_tokens // 0))
        else
            null
        end
    ' 2>/dev/null)
fi

# Fallback: Native context_window (conversation only, missing MCP/system overhead)
if [[ -z "$input_tokens" ]] || [[ "$input_tokens" == "null" ]]; then
    native_input=$(echo "$input" | jq -r '.context_window.total_input_tokens // null')
    native_output=$(echo "$input" | jq -r '.context_window.total_output_tokens // null')
    native_limit=$(echo "$input" | jq -r '.context_window.context_window_size // null')

    if [[ "$native_input" != "null" ]] && [[ -n "$native_input" ]]; then
        input_tokens=$((native_input + native_output))
        if [[ "$native_limit" != "null" ]] && [[ -n "$native_limit" ]]; then
            context_limit="$native_limit"
        fi
    fi
fi

# If still no data, check if transcript exists but has no usage yet
if [[ -z "$input_tokens" ]] || [[ "$input_tokens" == "null" ]]; then
    if [[ ! -f "$transcript_path" ]]; then
        printf "ğŸ§  Transcript not found ğŸ“ ${cwd}"
        exit 0
    fi
    printf "ğŸ§  No token usage yet ğŸ“ ${cwd}"
    exit 0
fi

# Calculate percentage
percent=$(awk "BEGIN {printf \"%.0f\", ($input_tokens/$context_limit)*100}")

# Format with K notation (e.g., "48k" instead of "48,000")
if (( input_tokens >= 1000 )); then
    tokens_fmt=$(awk "BEGIN {printf \"%.0fk\", $input_tokens/1000}")
else
    tokens_fmt="${input_tokens}"
fi

# Format context limit with K notation
if (( context_limit >= 1000 )); then
    limit_fmt=$(awk "BEGIN {printf \"%.0fk\", $context_limit/1000}")
else
    limit_fmt="${context_limit}"
fi

# Color based on percentage (matching ccusage thresholds)
if (( percent >= 80 )); then
    color="\033[31m"  # Red
elif (( percent >= 50 )); then
    color="\033[33m"  # Yellow
else
    color="\033[32m"  # Green
fi
reset="\033[0m"

# Output format: "ğŸ§  64k/200k (32%) Â· Sonnet 4.5 ğŸ“ /path" - all on one line
printf "${color}ğŸ§  ${tokens_fmt}/${limit_fmt} (${percent}%%) Â· ${model_name}${reset} ğŸ“ ${cwd}"
